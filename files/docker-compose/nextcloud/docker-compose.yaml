services:
  mariadb:
    image: mariadb:10.6
    restart: always
    command: --transaction-isolation=READ-COMMITTED --log-bin=binlog --binlog-format=ROW
    volumes:
      - /mnt/services/disk-0/nextcloud/mariadb:/var/lib/mysql
    environment:
      - MYSQL_ROOT_PASSWORD={{ nextcloud_db_root_password }}
      - MYSQL_PASSWORD={{ nextcloud_db_password }}
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
    networks:
      - proxy

  nextcloud:
    image: nextcloud:31.0.14
    restart: always
    # ports:
    #   - 8080:80
    links:
      - mariadb
    volumes:
      - /mnt/services/disk-0/nextcloud/nextcloud:/var/www/html
    environment:
      - MYSQL_PASSWORD={{ nextcloud_db_password }}
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
      - MYSQL_HOST=mariadb
    labels:
      # TRAEFIK
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      # HTTPS Router
      - "traefik.http.routers.nextcloud.rule=Host(`nextcloud.{{ domain }}`)"
      - "traefik.http.routers.nextcloud.entrypoints=websecure"
      - "traefik.http.routers.nextcloud.tls=true"
      - "traefik.http.routers.nextcloud.tls.certresolver=stepca"
      # HTTP Router (redirect only)
      - "traefik.http.routers.nextcloud-http.rule=Host(`nextcloud.{{ domain }}`)"
      - "traefik.http.routers.nextcloud-http.entrypoints=web"
      - "traefik.http.routers.nextcloud-http.middlewares=nextcloud-redirect"
      # Redirect middleware
      - "traefik.http.middlewares.nextcloud-redirect.redirectscheme.scheme=https"
      - "traefik.http.middlewares.nextcloud-redirect.redirectscheme.permanent=true"
      - "traefik.http.services.nextcloud.loadbalancer.server.port=80"
    networks:
      - proxy

networks:
  proxy:
    external: true